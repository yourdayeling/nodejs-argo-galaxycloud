name: Keep Galaxy Cloud App Active

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹è¿è¡Œ (UTC 2:00)
    # å¯æ ¹æ®éœ€è¦è°ƒæ•´é¢‘ç‡
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Update README with timestamp
        run: |
          # è·å–å½“å‰æ—¶é—´
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')
          
          # ç¡®ä¿ README.md å­˜åœ¨
          if [ ! -f README.md ]; then
            echo "# ${GITHUB_REPOSITORY#*/}" > README.md
            echo "" >> README.md
            echo "This project is automatically kept active on Galaxy Cloud." >> README.md
          fi
          
          # æ›´æ–°æˆ–æ·»åŠ æ—¶é—´æˆ³éƒ¨åˆ†
          if grep -q "<!-- AUTO-UPDATE-START -->" README.md; then
            # å¦‚æœæ ‡è®°å­˜åœ¨,æ›¿æ¢æ•´ä¸ªåŒºå—
            sed -i '/<!-- AUTO-UPDATE-START -->/,/<!-- AUTO-UPDATE-END -->/c\<!-- AUTO-UPDATE-START -->\n**ğŸ¤– Last auto-update:** '"$TIMESTAMP"'\n<!-- AUTO-UPDATE-END -->' README.md
          else
            # å¦‚æœæ ‡è®°ä¸å­˜åœ¨,æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾
            echo "" >> README.md
            echo "---" >> README.md
            echo "<!-- AUTO-UPDATE-START -->" >> README.md
            echo "**ğŸ¤– Last auto-update:** $TIMESTAMP" >> README.md
            echo "<!-- AUTO-UPDATE-END -->" >> README.md
          fi
          
          echo "Updated timestamp: $TIMESTAMP"
      
      - name: Commit and push changes
        run: |
          git add README.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "chore: auto-update timestamp [skip ci]"
          
          # æ¨é€æ›´æ”¹
          git push origin HEAD:${GITHUB_REF#refs/heads/}
          
          echo "âœ… Successfully pushed updates"
      
      - name: Deployment triggered
        run: |
          echo "ğŸš€ Changes pushed to trigger Galaxy Cloud deployment"
          echo "â° Next run will be in 24 hours"
